{%- style -%}
  :root  {
    --animate-duration: 1s;
    --animate-delay: 1s;
    --animate-repeat: 1;
  }
  .animate__animated {
    -webkit-animation-duration: 1s;
    animation-duration: 1s;
    -webkit-animation-duration: var(--animate-duration);
    animation-duration: var(--animate-duration);
    -webkit-animation-fill-mode: both;
    animation-fill-mode: both;
  }
  @-webkit-keyframes fadeOut {
    from {
      opacity: 1;
    }

    to {
      opacity: 0;
    }
  }
  @keyframes fadeOut {
    from {
      opacity: 1;
    }

    to {
      opacity: 0;
    }
  }
  .animate__fadeOut {
    -webkit-animation-name: fadeOut;
    animation-name: fadeOut;
  }

  @-webkit-keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }
  @keyframes fadeIn {
    from {
      opacity: 0;
    }

    to {
      opacity: 1;
    }
  }
  .animate__fadeIn {
    -webkit-animation-name: fadeIn;
    animation-name: fadeIn;
  }

  .product_page_button > svg {
    width: 40px;
    height: 40px;
    fill: transparent;
    stroke: #000;
    stroke-width: 40px;
    cursor: pointer;
  }

  .wishlist_icon > svg {
    position: absolute;
    width: 30px;
    height: 30px;
    cursor: pointer;
    left: 10px;
    top: 10px;
    fill: transparent;
    stroke: black;
    stroke-width: 50px;
    z-index: 100;
  }
  .active_icon > svg {
    fill: red;
    stroke: red;
  }
  .custom_header_icon {
    padding: 5px 11px;
    position: relative;
    cursor: pointer;
  }
  .custom_header_icon > svg {
    fill: transparent;
    stroke: var(--link);
    stroke-width: 50px;
    width: 30px;
    height: 30px;
  }


  .custom_mobile {
    padding: 0;
  }

  {{ section.settings.header_button }}
  {
    align-items: center;
  }

  .counter {
    background-color: orange;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    color: white;
    line-height: 20px;
    text-align: center;
    position: absolute;
    top: 0;
    left: 30px;
  }
  .mobile_counter {
    top: 10px;
    left: 20px;
  }

  .ws-btn {
    cursor: pointer;
    text-decoration: none;
    background-color: #212121;
    color: #fff;
    padding: 10px 18px;
    width: fit-content;
  }

  .ws-btn:hover {
    background-color: #000;
    color: #fff;
  }

  .wishlist_container {
    max-width: 700px;
    margin: 20px auto;
  }

  .empty_wishlist {
    max-width: 700px;
    margin: 20px auto;
  }

  .voo-custom_loader {
    width: 100%;
    text-align: center;
    padding: 50px 0;
    font-size: 24px;
  }
  .empty_text {
    text-align: center;
    padding: 20px 0;
  }

  .empty_btn_container {
    width: 100%;
    display: flex;
    justify-content: center;
    margin: 20px 0;
  }

  .clear_btn_container {
    position: absolute;
    top: 20px;
    left: 20px;
  }

  .product-grid-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: flex-start;
  }
  .grid-item {
    width: 25%;
  }

  .wishlist_popup {
    max-width: 350px;
    cursor: pointer;
    z-index: 9999;
    background-color: #fff;
    position: fixed;
    top: 100px;
    left: -400px;
    transition: left 0.5s ease-in-out;

    display: flex;
    column-gap: 15px;
    padding: 15px 30px 15px 15px;
    box-shadow: rgba(0, 0, 0, 0.25) 0 54px 55px, rgba(0, 0, 0, 0.12) 0 -12px 30px, rgba(0, 0, 0, 0.12) 0 4px 6px, rgba(0, 0, 0, 0.17) 0 12px 13px, rgba(0, 0, 0, 0.09) 0 -3px 5px;
  }
  .wishlist_popup_open {
    top: 100px;
    left: 20px;
    transition: left 0.5s ease-in-out;
  }

  @media only screen and (max-width : 400px) {
    .wishlist_popup {
      top: -1000px;
      left: 0;
      width: 100%;
      max-width: none;
    }

    .wishlist_popup_open {
      top: 0;
      left: 0;
      transition: top 0.5s ease-in-out;
    }
  }

  .wishlist_popup > img {
    width: 60px;
    height: auto;
  }

  .wishlist_popup .title {
    font-weight: bold;
    margin-bottom: 10px;
  }

  .wishlist_modal {
    position: fixed;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 9999;
    top: 0;
    left: 0;
    display: none;
  }

  .wishlist_modal_open {
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .wishlist_modal_content {
    background-color: #fff;
    padding: 75px 20px 20px;
    width: 80%;
    max-height: 80%;
    overflow: auto;
    position: relative;
  }
  .close_modal_btn {
    width: 100%;
    display: flex;
    justify-content: flex-end;
    position: absolute;
    right: 20px;
    top: 22px;
  }
  .close_modal_btn > svg {
    cursor: pointer;
  }

  .popup_close_btn {
    position: absolute;
    right: 10px;
    top: 10px;
    cursor: pointer;
  }

  @media only screen and (max-width : 991px) {
    .grid-item {
      width: 50%;
    }
  }
  @media only screen and (max-width : 767px) {
    .grid-item {
      width: 100%;
    }
    .header__mobile__button {
      margin: 0 13px 0 0
    }
  }
{%- endstyle -%}
<div>
  <div class="wishlist_popup">
    <div class="popup_close_btn">
      <svg
        width="15"
        height="15"
        id="Layer_1"
        data-name="Layer 1"
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 122.88 122.88">
        <defs>
          <style>
            .cls-1 {
              fill: #000;
              fill-rule: evenodd;
            }
          </style>
        </defs>
        <path class="cls-1" d="M61.44,0A61.44,61.44,0,1,1,0,61.44,61.44,61.44,0,0,1,61.44,0ZM74.58,36.8c1.74-1.77,2.83-3.18,5-1l7,7.13c2.29,2.26,2.17,3.58,0,5.69L73.33,61.83,86.08,74.58c1.77,1.74,3.18,2.83,1,5l-7.13,7c-2.26,2.29-3.58,2.17-5.68,0L61.44,73.72,48.63,86.53c-2.1,2.15-3.42,2.27-5.68,0l-7.13-7c-2.2-2.15-.79-3.24,1-5l12.73-12.7L36.35,48.64c-2.15-2.11-2.27-3.43,0-5.69l7-7.13c2.15-2.2,3.24-.79,5,1L61.44,49.94,74.58,36.8Z" /></svg>
    </div>
    <img
      src=""
      alt=""
      width="180"
      height="320">
    <div class="popup_info">
      <div class="title"></div>
      <div class="text">has been added to list successfully</div>
    </div>
  </div>
  <div class="wishlist_modal">
    <div class="wishlist_modal_content">
      <div class="close_modal_btn">
        <svg
          width="30"
          height="30"
          id="Layer_1"
          data-name="Layer 1"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 122.88 122.88">
          <defs>
            <style>
              .cls-1 {
                fill: #000;
                fill-rule: evenodd;
              }
            </style>
          </defs>
          <path class="cls-1" d="M61.44,0A61.44,61.44,0,1,1,0,61.44,61.44,61.44,0,0,1,61.44,0ZM74.58,36.8c1.74-1.77,2.83-3.18,5-1l7,7.13c2.29,2.26,2.17,3.58,0,5.69L73.33,61.83,86.08,74.58c1.77,1.74,3.18,2.83,1,5l-7.13,7c-2.26,2.29-3.58,2.17-5.68,0L61.44,73.72,48.63,86.53c-2.1,2.15-3.42,2.27-5.68,0l-7.13-7c-2.2-2.15-.79-3.24,1-5l12.73-12.7L36.35,48.64c-2.15-2.11-2.27-3.43,0-5.69l7-7.13c2.15-2.2,3.24-.79,5,1L61.44,49.94,74.58,36.8Z" /></svg>
      </div>
    </div>
  </div>
</div>
<script>
  let popup = document.querySelector(".wishlist_popup");
  let popupImage = popup.querySelector("img");
  let popupTitle = popup.querySelector(".title");

  popup.querySelector(".popup_close_btn").addEventListener("click", (e) => {
    e.stopPropagation();
    popup.classList.remove("wishlist_popup_open");
  });


  let modal = document.querySelector(".wishlist_modal");
  if ("{{ section.settings.is_enabled }}" == "true") {
    let filterTarget = document.querySelector('.product-grid');
    let recTarget = document.querySelector('.collection-list');
    const config = {
      childList: true
    };
    const callback = function(mutationsList, observer) {
      for (let mutation of mutationsList) {
        if (mutation.type === 'childList') {
          setButtons();
        }
      }
    };

    const observer = new MutationObserver(callback);
    if (filterTarget) {
      observer.observe(filterTarget, config);
    }
    if (recTarget) {
      observer.observe(recTarget, config);
    }


    let wishlist = [];
    try {
      wishlist = JSON.parse(localStorage.getItem("wishlist"));
    } catch {
      wishlist = [];
    }
    if (! wishlist) {
      wishlist = [];
    }




  let emptyWishlistContainer = document.createElement("div");
  emptyWishlistContainer.classList.add("empty_wishlist");
  let emptyWishlist = `
            <div class="empty_text">{{ section.settings.empty_text }}</div>
            <div class="empty_btn_container">
              <a class="ws-btn" href="{{ section.settings.button_url }}">{{ section.settings.button_text }}</a>
            </div>
          `;
  emptyWishlistContainer.innerHTML += emptyWishlist;

  let container;
  if ("{{ section.settings.is_modal  }}" == "true") {
    container = document.querySelector(".wishlist_modal_content");
  } else {
    container = document.querySelector("main");
  }

  let main = document.createElement("div");


  let counter = document.createElement("div");
  let mobileCounter = document.createElement("div");
  counter.classList.add("counter");
  mobileCounter.classList.add("counter", "mobile_counter");
  counter.innerText = wishlist.length;
  mobileCounter.innerText = wishlist.length;
  document.addEventListener("DOMContentLoaded", function(event) {
    if ("{{ page.id }}" === "{{ section.settings.page.id }}") {
      getContent();
    } else {
      setButtons();
    }

    function getContent() {
      if ("{{ section.settings.is_modal }}" == "true") {
        container.appendChild(main);
      } else {
        container.prepend(main);
      }
      if (wishlist.length > 0) {
        let clearBtn = document.createElement("div");
        clearBtn.classList.add("clear_btn_container");
        clearBtn.innerHTML = `<div class="ws-btn animate__fadeIn animate__animated">{{ section.settings.clear_button_text  }}</div>`;
        clearBtn.addEventListener("click", () => {
          localStorage.removeItem("wishlist");
          wishlist = [];
          let cards = main.querySelectorAll("{{ section.settings.card_selector }}");
          cards = [... cards].reverse();
          cards.forEach((card, index) => {
            setTimeout(() => {
              card.classList.add("animate__fadeOut", "animate__animated");
              card.onanimationend = () => {
                card.remove();
                if (index === cards.length - 1) {
                  main.innerHTML = "";
                  main.prepend(emptyWishlistContainer);
                }
              };
            }, index * 200);
          });
          setButtons();
          counter.innerText = wishlist.length;
          mobileCounter.innerText = wishlist.length;
        });


        let loader = document.createElement("div");
        loader.classList.add("voo-custom_loader");
        loader.innerText = "Loading...";

        main.prepend(loader);
        let products_w = document.createElement("div");
        products_w.classList.add("product-grid-container");
        let featuredProducts = [];
        Promise.all(wishlist.map(async link => {
          await fetch('/products/' + link + "/?view=wishlist").then(function(response) {
            return response.text();
          }).then(function(html) {
            let item = document.createElement("div");
            item.classList.add("grid-item", "animate__animated", "animate__fadeIn");
            item.innerHTML += html;
            featuredProducts.push(item);
          });
        })).then(() => {
          loader.remove();
          main.append(clearBtn);
          main.append(products_w);
          let wishlistTarget = document.querySelector('.product-grid-container');
          if (wishlistTarget) {
            observer.observe(wishlistTarget, config);
          }
          featuredProducts.forEach((product, index) => {
            setTimeout(() => {
              products_w.append(product);
            }, index * 200);
          });
        });
      } else {
        main.prepend(emptyWishlistContainer);
      }
    }
    if ("{{ product }}") {
      let productWishButtonPlacement = document.querySelector("{{ section.settings.product_page_selector }}");
      let productPageIcon = document.createElement("div");
      productPageIcon.innerHTML += '{{ section.settings.icon }}';
      productPageIcon.classList.add("product_page_button");
      wishlist.forEach(wish => {
        if (wish == "{{ product.url }}".replace("/products/", "")) {
          productPageIcon.classList.add("active_icon");
        }
      });
      productWishButtonPlacement.appendChild(productPageIcon);

      productPageIcon.addEventListener("click", () => {
        heartClick(productPageIcon, "{{ product.url }}".replace("/products/", ""));
      });
    }

    let headerPlacement = document.querySelector("{{ section.settings.header_button }}");
    let headerMobilePlacement = document.querySelector(".header__mobile__right");
    let headerPlacementPosition = "{{ section.settings.header_button_position }}";
    let icon = document.createElement("div");
    let mobileIcon = document.createElement("div");
    icon.classList.add("custom_header_icon", "header__desktop__button", "wishlist_trigger");
    mobileIcon.classList.add("custom_header_icon", "custom_mobile", "header__mobile__button", "btnWish");
    mobileIcon.innerHTML += '{{ section.settings.icon }}';
    icon.innerHTML += '{{ section.settings.icon }}';
    if ("{{ section.settings.is_counter }}" == "true") {
      mobileIcon.appendChild(mobileCounter);
      icon.appendChild(counter);
    }
    if(headerPlacementPosition === "before"){
      setTimeout(() => {
        headerPlacement.prepend(icon);
        headerMobilePlacement.prepend(mobileIcon);
      }, 100);
    } else if (headerPlacementPosition === "after"){
      headerPlacement.appendChild(icon);
      headerMobilePlacement.appendChild(mobileIcon);
    }
    headerPlacement.appendChild(icon);
    headerMobilePlacement.appendChild(mobileIcon);

    icon.addEventListener("click", () => {
      openWishlist();
    });
    mobileIcon.addEventListener("click", () => {
      openWishlist();
    });

    function openWishlist() {
      if ("{{ section.settings.is_modal }}" == "true") {
        modal.classList.add("wishlist_modal_open");
        getContent();
      } else {
        openProductPage("{{ section.settings.page.url }}");
      }

    }

    if ("{{ section.settings.is_modal }}" == "true") {
      let closeBtn = document.querySelector(".close_modal_btn").querySelector("svg");
      closeBtn.addEventListener("click", () => {
        modal.classList.remove("wishlist_modal_open");
        main.innerHTML = "";
      });
    }
  });

  function setButtons() {
    let cards;
    cards = document.querySelectorAll("{{ section.settings.card_selector }}");
    cards.forEach(card => {
      let hasIcon = card.querySelector(".wishlist_icon");
      if (hasIcon) {
        hasIcon.remove();
      }
      let buttonPlacement = card.querySelector("{{ section.settings.card_button }}") || card;
      if (buttonPlacement) {
        let slug = card.querySelector(".product-link").attributes.href ?. value;
        if (slug) {
          if (slug.indexOf("?") !== -1) {
            slug = slug.slice(0, slug.indexOf("?"));
          }
          if (slug.indexOf("/products/") !== -1) {
            slug = slug.slice(slug.indexOf("/products/")).replace("/products/", "");
          }
        };

        let icon = document.createElement("div");
        icon.classList.add("wishlist_icon");
        icon.innerHTML += '{{ section.settings.icon }}';
        buttonPlacement.appendChild(icon);
        wishlist.forEach(wish => {
          if (wish === slug) {
            icon.classList.add("active_icon");
          }
        });

        icon.addEventListener("click", () => {
          heartClick(icon, slug, card);
        });
      }
    });
  }
  let timerHandle;

  function openProductPage(url) {
    window.location.assign(url);
  }

  function heartClick(icon, slug, card) {
    function poputOpenPage(e) {
      e.stopImmediatePropagation();
      openProductPage("/products/" + slug);
    }
    let elemIndex = wishlist.indexOf(slug);
    if (elemIndex === -1) {
      if (wishlist.length < "{{ section.settings.max_item }}") {
        popup.removeEventListener("click", poputOpenPage);
        wishlist.push(slug);
        icon.classList.add("active_icon");
        counter.innerText = wishlist.length;
        mobileCounter.innerText = wishlist.length;
        let isOpen = popup.classList.contains("wishlist_popup_open");
        popup.classList.remove("wishlist_popup_open");
        clearTimeout(timerHandle);
        fetch('/products/' + slug + ".json").then(function(response) {
          return response.json();
        }).then(result => {
          timerHandle = setTimeout(() => {
            popup.classList.remove("wishlist_popup_open");
          }, 5000);
          popup.addEventListener("click", poputOpenPage);
          popupImage.src = result.product.image.src;
          let popupTitleText = result.product.title + " - " + result.product.variants[0].title;
          popupTitle.innerText = popupTitleText;

          popup.classList.add("wishlist_popup_open");
        });
      }
    } else {
      wishlist.splice(elemIndex, 1);
      icon.classList.remove("active_icon");
      if ("{{ page.id }}" === "{{ section.settings.page.id }}" || ("{{ section.settings.is_modal }}" && modal.classList.contains("wishlist_modal_open"))) {
        card.classList.add("animate__fadeOut", "animate__animated");
        setTimeout(() => {
          card.parentNode.remove();
          if (wishlist.length <= 0) {
            main.innerHTML = "";
            main.prepend(emptyWishlistContainer);
          }
        }, 1000)
      }
      counter.innerText = wishlist.length;
      mobileCounter.innerText = wishlist.length;
    }
    localStorage.setItem("wishlist", JSON.stringify(wishlist));
    setButtons();
  }
}
</script>
{%- schema -%}
  {
    "name": "wishlist",
    "class": "spaced-section",
    "tag": "section",
    "limit": 1,
    "settings": [
      {
        "type": "checkbox",
        "id": "is_enabled",
        "label": "Enable wishlist",
        "default": true
      },
      {
        "type": "text",
        "id": "card_selector",
        "label": "Card selector",
        "default": ".card--standart"
      },
      {
        "type": "text",
        "id": "card_button",
        "label": "Card button selector",
        "default": ".card__inner"
      },
      {
        "type": "text",
        "id": "header_button",
        "label": "Header button selector"
      },
      {
        "type": "select",
        "id": "header_button_position",
        "label": "Header button position",
        "options": [
          {
            "value": "before",
            "label": "Before"
          },
          {
            "value": "after",
            "label": "After"
          }
        ],
        "default": "before"
      },
      {
        "type": "html",
        "id": "icon",
        "label": "SVG icon"
      }, {
        "type": "checkbox",
        "id": "is_counter",
        "label": "Show counter",
        "default": true
      }, {
        "type": "range",
        "id": "max_item",
        "label": "Max item to add",
        "min": 1,
        "max": 25,
        "default": 10,
        "step": 1
      }, {
        "type": "page",
        "id": "page",
        "label": "Wishlist page"
      }, {
        "type": "richtext",
        "id": "empty_text",
        "label": "Empty wishlist text"
      }, {
        "type": "text",
        "id": "button_text",
        "label": "Button text"
      }, {
        "type": "url",
        "id": "button_url",
        "label": "Button url"
      }, {
        "type": "text",
        "id": "clear_button_text",
        "label": "Clear button text"
      }, {
        "type": "checkbox",
        "id": "is_modal",
        "label": "Enable modal",
        "default": true
      }, {
        "type": "text",
        "id": "product_page_selector",
        "label": "Button product page selector",
        "default": ".product__submit__item"
      }
    ]
  }
{%- endschema -%}
